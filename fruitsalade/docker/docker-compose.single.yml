# Single-container deployment: PostgreSQL + FruitSalade server + FUSE client
#
# Uses local filesystem storage (no MinIO/S3 required).
# Data persists via named volumes.
# FUSE client is enabled by default, mounting at /mnt/fruitsalade inside the container.
#
# Usage:
#   docker compose -f fruitsalade/docker/docker-compose.single.yml up -d
#   curl http://localhost:8080/health
#   Browse: http://localhost:8080/app/
#
#   # Access the FUSE mount inside the container:
#   docker compose -f fruitsalade/docker/docker-compose.single.yml exec fruitsalade ls /mnt/fruitsalade

services:
  fruitsalade:
    build:
      context: ../..
      dockerfile: fruitsalade/docker/Dockerfile.single
    ports:
      - "8080:8080"
      - "9090:9090"
    environment:
      POSTGRES_USER: fruitsalade
      POSTGRES_PASSWORD: fruitsalade
      POSTGRES_DB: fruitsalade
      JWT_SECRET: change-me-in-production
      STORAGE_BACKEND: local
      LOCAL_STORAGE_PATH: /data/storage
      SEED_DATA: "true"
      LOG_LEVEL: info
      LOG_FORMAT: console
      ENABLE_FUSE: "true"
      FUSE_MOUNT: /mnt/fruitsalade
      FUSE_USER: admin
      FUSE_PASSWORD: admin
    volumes:
      - pg_data:/data/postgres
      - storage_data:/data/storage
    cap_add:
      - SYS_ADMIN
    devices:
      - /dev/fuse
    security_opt:
      - apparmor:unconfined

volumes:
  pg_data:
  storage_data:
