name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: |
            shared/go.sum
            fruitsalade/go.sum
      - name: Vet shared
        run: cd shared && go vet ./...
      - name: Vet app
        run: cd fruitsalade && go vet ./...

  test-unit:
    name: Test (${{ matrix.module }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        module: [shared, fruitsalade]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: ${{ matrix.module }}/go.sum
      - name: Run unit tests
        run: cd ${{ matrix.module }} && go test -short -count=1 ./...

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: fruitsalade
          POSTGRES_PASSWORD: fruitsalade
          POSTGRES_DB: fruitsalade_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U fruitsalade"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
        options: >-
          --health-cmd "mc ready local || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: fruitsalade/go.sum
      - name: Create MinIO bucket
        run: |
          curl -fsSL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
          chmod +x /usr/local/bin/mc
          mc alias set local http://localhost:9000 minioadmin minioadmin
          mc mb local/fruitsalade-test
      - name: Run integration tests
        env:
          TEST_DATABASE_URL: "postgres://fruitsalade:fruitsalade@localhost:5432/fruitsalade_test?sslmode=disable"
          TEST_S3_ENDPOINT: "http://localhost:9000"
        run: cd fruitsalade && go test -v -count=1 ./internal/api/

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: |
            shared/go.sum
            fruitsalade/go.sum
      - name: Build server
        run: cd fruitsalade && go build -o ../bin/server ./cmd/server
      - name: Build FUSE client
        run: cd fruitsalade && go build -o ../bin/fuse-client ./cmd/fuse-client
      - name: Build seed tool
        run: cd fruitsalade && go build -o ../bin/seed-tool ./cmd/seed-tool
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/
          retention-days: 7
